
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Visitors ‚Ä¢ BoardRankCTG</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" />
</head>
<body>
  <header>
    <h1>All Visitors</h1>
    <h2>Chattogram Board Students' SSC & HSC Ranking</h2>
  </header>

  <main style="max-width: 900px; margin: auto;">
    <table border="1" style="width:100%; border-collapse: collapse;">
      
      <thead>
        <tr>
          <th>No.</th>
          <th>Name</th>
          <th>Type</th>
          <th>Source</th>
          <th>Institution</th>
          <th>Experience</th>
          <th>Message</th>
          <th>Device</th>
          <th>Fingerprint</th> <!-- ‚úÖ Added -->
          <th>Date</th>
          <th>Action</th>
        </tr>
      </thead>
      
      
  </thead>
  
      <tbody id="visitorsContainer"></tbody>
    </table>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, onValue, remove } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  
// --- Project 1: boardrankctg (DATABASE) ---
const dbConfig = {
  apiKey: "AIzaSyBaKVrTWKeaUxa0EaiDBR8OGpGCAjxAcUA",
  authDomain: "boardrankctg.firebaseapp.com",
  databaseURL: "https://boardrankctg-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "boardrankctg",
  storageBucket: "boardrankctg.appspot.com",
  messagingSenderId: "751761229963",
  appId: "1:751761229963:web:43f9dbf71feef6dc9cec8e"
};
const dbApp = initializeApp(dbConfig, "dbApp"); 
const db = getDatabase(dbApp);

// --- Project 2: boardrank-c095a (AUTH) ---
const authConfig = {
  apiKey: "AIzaSyAwUqYxrhyEZDmvlQaUB7tuVtXP1ZYdKfI",
  authDomain: "boardrank-c095a.firebaseapp.com",
  projectId: "boardrank-c095a",
  storageBucket: "boardrank-c095a.appspot.com",
  messagingSenderId: "953246350478",
  appId: "1:953246350478:web:xxxxxxxxxxxxxxxx" // ‚Üê copy exact value from Firebase settings
};
const authApp = initializeApp(authConfig, "authApp");
const auth = getAuth(authApp);

    const ADMIN_UID = "m2yGng2JRBfvG5MKGf5A977t5Az2";
  
    const main = document.querySelector('main');
    const container = document.getElementById("visitorsContainer");
  
    // Login box
    const loginHtml = `
  <div id="adminLoginBox" style="max-width:900px;margin:10px auto;padding:12px;border-radius:8px;background:#fff;">
    <div style="display:flex;align-items:center;gap:10px;">
      <input id="adminEmail" placeholder="Admin email" style="padding:8px;flex:1;" />
      <input id="adminPassword" type="text" placeholder="Password" style="padding:8px;width:180px;" />
      <button id="loginBtn">Login</button>
      <button id="logoutBtn" style="display:none;">Logout</button>
    </div>
    <div id="loginError" style="color:#b71c1c;margin-top:6px;"></div>
  </div>
`;
main.insertAdjacentHTML('afterbegin', loginHtml);

  
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const loginError = document.getElementById('loginError');
  
    onAuthStateChanged(auth, user => {
      if (user && user.uid === ADMIN_UID) {
        document.getElementById('adminLoginBox').style.display = 'none';
        loadVisitors();
      } else {
        document.getElementById('adminLoginBox').style.display = 'block';
        container.innerHTML = `<tr><td colspan="10" style="text-align:center;color:#b71c1c;">Admin access required. Please login.</td></tr>`;
      }
    });
  
    loginBtn.addEventListener('click', async () => {
      loginError.textContent = '';
      const email = document.getElementById('adminEmail').value.trim();
      const password = document.getElementById('adminPassword').value;
      if (!email || !password) {
        loginError.textContent = 'Enter email and password.';
        return;
      }
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (err) {
  console.error('Login failed:', err);
  loginError.textContent = 'Login failed: ' + (err.message || err.code);
}

    });
  
    logoutBtn.addEventListener('click', async () => {
      await signOut(auth);
      location.reload();
    });
  
    function loadVisitors() {
      const visitorsRef = ref(db, "visitors");
      onValue(visitorsRef, (snapshot) => {
        container.innerHTML = "";
        const visitors = snapshot.val() || {};
        const entries = Object.entries(visitors).reverse();
        let count = entries.length;
        entries.forEach(([id, visitor]) => {
          const escapeHtml = (str) => String(str || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
          const tr = document.createElement('tr');
tr.innerHTML = `
  <td>${count--}</td>
  <td>${escapeHtml(visitor.name || '')}</td>
  <td>${escapeHtml(visitor.type || '')}</td>
  <td>${escapeHtml(visitor.source || '')}</td>
  <td>${escapeHtml(visitor.institution || '')}</td>
  <td>${escapeHtml(visitor.experience || '')}</td>
  <td>${visitor.message ? '<div class="visitor-message">' + escapeHtml(visitor.message) + '</div>' : ''}</td>
 <td>${escapeHtml(visitor.deviceData?.deviceModel || 'Unknown')}</td>
<td>${escapeHtml(visitor.fingerprint || '‚Äî')}</td>
<td>${visitor.timestamp ? new Date(visitor.timestamp).toLocaleString() : ''}</td>
<td>
  <button onclick="deleteVisitor('${id}')">üóëÔ∏è Delete</button>
  <button onclick="openBlockModal('${visitor.fingerprint || ''}')">‚õî Block</button>
  <button onclick="unblockByFingerprint('${visitor.fingerprint || ''}')">‚úÖ Unblock</button>
</td>


`;

          container.appendChild(tr);
        });
      });
    }
  
    window.deleteVisitor = function(id) {
      if (!confirm("Delete this visitor?")) return;
      remove(ref(db, `visitors/${id}`)).catch(err => {
        alert('Delete failed ‚Äî permission denied.');
      });
    };


    window.openBlockModal = function(fingerprint) {
  if (!fingerprint) return alert('No fingerprint found.');
  const minutes = parseInt(prompt('Block for how many minutes?', '60'), 10);
  if (isNaN(minutes) || minutes <= 0) return alert('Invalid time.');
  const reason = prompt('Enter reason for block:', 'Violation of rules');
  const fpHash = simpleHash(fingerprint);
  const now = Date.now();
  const expiresAt = now + minutes * 60 * 1000;
  firebaseAuthCheckAndWriteBlock(fpHash, reason, now, expiresAt);
};

window.unblockByFingerprint = async function(fingerprint) {
  if (!fingerprint) return alert('No fingerprint found.');
  const user = firebase.auth().currentUser;
  if (!user || user.uid !== ADMIN_UID) {
    return alert('Only admin can unblock.');
  }
  const fpHash = simpleHash(fingerprint);
  await firebase.database().ref('blocks/' + fpHash).remove();
  alert('Unblocked.');
};


function simpleHash(s) {
  let h = 2166136261 >>> 0;
  for (let i = 0; i < s.length; i++) {
    h ^= s.charCodeAt(i);
    h += (h << 1) + (h << 4) + (h << 7) + (h << 8) + (h << 24);
  }
  return (h >>> 0).toString(16);
}

function openBlockModal(fingerprint) {
  if (!fingerprint) return alert('No fingerprint found.');
  const minutes = parseInt(prompt('Block for how many minutes?', '60'), 10);
  if (isNaN(minutes) || minutes <= 0) return alert('Invalid time.');
  const reason = prompt('Enter reason for block:', 'Violation of rules');
  const fpHash = simpleHash(fingerprint);
  const now = Date.now();
  const expiresAt = now + minutes * 60 * 1000;
  firebaseAuthCheckAndWriteBlock(fpHash, reason, now, expiresAt);
}

async function firebaseAuthCheckAndWriteBlock(fpHash, reason, now, expiresAt) {
  const user = firebase.auth().currentUser;
  if (!user || user.uid !== ADMIN_UID) {
    return alert('Only admin can block.');
  }
  await firebase.database().ref('blocks/' + fpHash).set({
    fingerprintHash: fpHash,
    reason,
    blockedByUid: user.uid,
    blockedByEmail: user.email || '',
    createdAt: now,
    expiresAt,
    active: true
  });
  alert('Blocked.');
}

async function unblockByFingerprint(fingerprint) {
  if (!fingerprint) return alert('No fingerprint found.');
  const user = firebase.auth().currentUser;
  if (!user || user.uid !== ADMIN_UID) {
    return alert('Only admin can unblock.');
  }
  const fpHash = simpleHash(fingerprint);
  await firebase.database().ref('blocks/' + fpHash).remove();
  alert('Unblocked.');
}
  
  </script>
  
  
</body>
</html>
